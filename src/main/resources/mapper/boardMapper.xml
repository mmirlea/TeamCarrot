<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- mapper의 전체 경로 -->
<mapper namespace="com.carrot.board.dao.BoardMapper">

	<!-- 게시글 읽어오기 -->
	<select id="select" parameterType="int" resultType="BoardDTO">
		SELECT B_MENU,    B_NUM, 		B_CATE,   B_EMAIL,  B_TITLE,
			   B_CONTENT, B_IMG, 		B_CRDATE, B_UPDATE, B_TEMPSAVEYN,
			   B_LIKEY,   B_LIKEYEMAIL, B_COMM,   B_VIEWCNT
		FROM BOARD
		WHERE B_MENU = '2'
		  <include refid="searchCate"></include>
		  AND B_NUM = #{b_num}
		ORDER BY BNO DESC
	</select>

	<sql id="searchCate">
		<choose>
			<when test='option =="C"'>
			 	AND B_CATE = #{keyword}
			</when>
			<otherwise>
			</otherwise>
		</choose>
	</sql>

	<!-- 전체 게시물 개수 -->
	<select id="count" resultType="int">
		SELECT COUNT(*)
		  FROM BOARD
		 WHERE B_MENU = '2'
	</select>

	<!-- 글 추가하기 -->
	<insert id="insert" parameterType="BoardDTO">
		INSERT INTO BOARD (B_MENU, B_NUM, B_CATE, B_EMAIL, B_TITLE, B_CONTENT)
		VALUES (2, SEQ_BOARD_SEQ.NEXTVAL, #{b_cate}, #{b_email}, #{b_title}, #{b_content})
	</insert>

	<!-- 글 수정하기 -->
	<update id="update" parameterType="BoardDTO">
		UPDATE BOARD
		   SET B_TITLE = #{b_title},
		       B_CONTENT = #{b_content},
		       B_UPDATE = SYSDATE
		 WHERE B_MENU = '2'
		   AND B_NUM = #{b_num}
		   AND B_EMAIL = #{b_email}
	</update>

	<!-- 글 삭제하기(게시글 번호와 작성자가 일치하는 경우에만 삭제 가능) -->
	<delete id="delete" parameterType="map">
		DELETE FROM BOARD
		 WHERE B_MENU = '2'
		   AND B_NUM = #{b_num}
		   AND B_EMAIL = #{b_email}
	</delete>

	<!-- 관리자의 경우 삭제하도록 -->
<!-- 	<delete id="deleteForAdmin" parameterType="int">
		DELETE BOARD
		 WHERE B_MENU = '2'
		   AND B_NUM = #{b_num}
	</delete> -->

	<!-- 게시글 전체 삭제 -->
	<delete id="deleteAll">
		DELETE FROM BOARD
		 WHERE B_MENU = '2'
	</delete>

	<!-- 게시글 목록 조회(등록일 기준으로 내림차순) -->
	<select id="selectAll" resultType="BoardDTO">
		SELECT B_NUM, TITLE, CONTENT, WRITER, VIEW_CNT, COMMENTS_CNT, REG_DATE
		  FROM BOARD
		 WHERE B_MENU = '2'
		 ORDER BY REG_DATE DESC, BNO DESC
	</select>

	<!-- 조회수 증가 -->
	<update id="increaseViewCnt" parameterType="int">
		UPDATE BOARD
		   SET B_VIEWCNT = B_VIEWCNT + 1
		 WHERE B_MENU = '2'
		   AND B_NUM = #{b_num}
	</update>

	<!-- 페이징 처리하기 -->
	<select id="selectPage" parameterType="map" resultType="BoardDTO">
		SELECT *
		  FROM (SELECT ROWNUM RUNM, A.*
				  FROM (SELECT B_NUM, B_CATE, B_EMAIL, B_TITLE, B_CONTENT, B_CRDATE, B_LIKEY, B_COMM
					      FROM BOARD
					     WHERE B_MENU = '2'
						 ORDER BY REG_DATE DESC, BNO DESC) A)
		 WHERE RUNM BETWEEN ((NVL(#{page}, 0)-1) * #{pageSize} +1) AND (NVL(#{page}, 0) * #{pageSize})
	</select>

	<sql id="searchCondition">
		<choose>
			<when test='option =="T"'>
				AND B_TITLE LIKE '%'||#{keyword}||'%'
			</when>
			<when test='option =="W"'>
				AND B_EMAIL LIKE '%'||#{keyword}||'%'
			</when>
			<otherwise>
				AND (B_TITLE LIKE '%'||#{keyword}||'%' OR B_CONTENT LIKE '%'||#{keyword}||'%')
			</otherwise>
		</choose>
	</sql>

	<!-- 게시글 검색하기, 검색 후 페이징 처리 되어야 하기 때문에 --> 
	<!-- SearchCondition 어떤 패키지에 포함되어있는지 원래는 표기해야함 -> 등록하면 안해도됨  -->
<!-- 	<select id="searchSelectPage" parameterType="SearchCondition" resultType="BoardDTO">
		SELECT *
		  FROM (SELECT ROWNUM RUNM, A.*
				  FROM (SELECT B_NUM, B_CATE, B_EMAIL, B_TITLE, B_CONTENT, B_CRDATE, B_LIKEY, B_COMM
					      FROM BOARD
					     WHERE 1 = 1
					       AND B_MENU = '2'
					    <include refid="searchCondition"></include>
						ORDER BY REG_DATE DESC, BNO DESC) A)
		 WHERE RUNM BETWEEN ((NVL(#{page}, 0)-1) * #{pageSize} +1) AND (NVL(#{page}, 0) * #{pageSize})
	</select> -->

	<!-- 검색했을 때 게시글 개수 -->
<!-- 	<select id="searchResultCnt" parameterType="SearchCondition" resultType="int">
		SELECT COUNT(*)
	      FROM BOARD
	     WHERE 1 = 1
	       AND B_MENU = '2'
	    <include refid="searchCondition"></include>
	</select> -->

	<!-- 댓글 추가 삭제 시 board의 comments_cnt의 값이 달라져야함 -->
<!-- 	<update id="updateCommentsCnt" parameterType="map">
		UPDATE BOARD
		   SET B_COMM = B_COMM + #{cnt}
		   WHERE B_MENU = '2'
		     AND B_NUM = #{b_num}
	</update> -->

</mapper>